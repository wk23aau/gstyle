# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

### Added
- **Dynamic CV Backgrounds**:
    - Implemented a background switcher in `CVRenderer.tsx` allowing users to cycle through randomly generated abstract CSS gradient backgrounds for the CV preview card.
    - Backgrounds are generated on component mount, offering a variety of light, harmonious color palettes. Currently generates 30 distinct styles.
    - UI controls (Previous/Next buttons, style count display) added above the CV.
    - Added `ChevronLeftIcon` and `ChevronRightIcon` to `constants.tsx` for the switcher buttons.
    - The main CV card's background changes with a smooth CSS transition.
- **Sophisticated CV Rendering Design & Parsing**:
    - Significantly redesigned `CVRenderer.tsx` to display AI-generated CV outlines in a modern, professional, two-column format (inspired by "Siobhan Simmons" and "Hannah Singh" resume examples).
    - **Layout**: Features a left sidebar for prominent name, job title/tagline, contact details with icons, and a personal statement (summary). The right main column displays sections like Work Experience, Education, Skills, etc.
    - **Styling**: Employs a professional color palette (light slate sidebar, dark text, accent colors), clear typography (Roboto, Georgia), modern SVG icons for contact info, and improved spacing for enhanced readability.
    - **Advanced Parsing**: The internal `parseCvTextToSections` function in `CVRenderer.tsx` has been substantially improved to:
        - Accurately identify and structure top-level numbered sections from AI outlines (e.g., "1. Contact Information:", "2. Summary/Objective:").
        - Extract detailed contact information items.
        - Handle AI's sub-categorization within sections, especially for "Skills" (e.g., "Talent Acquisition & Recruitment:", "Technical Skills:"), rendering them as distinct sub-sections with their respective bullet points.
        - Parse "Work Experience" and "Education" entries into distinct fields (Title/Degree, Company/Institution, Dates, Responsibilities/Descriptions), including and displaying the AI's instructional text within these descriptions to guide the user.
        - Process other sections like "Projects," "Certifications," "Awards," and "Note" appropriately.
    - **Props Integration**: Uses `currentUser` details (name, email, phone, LinkedIn, profile photo) passed from `HeroSection.tsx` and `UserDashboardPage.tsx` to personalize the rendered CV header. Falls back to parsing from `cvText` if props are not available.
    - **New SVG Icons**: Added `PhoneIcon`, `EmailIcon`, `WebsiteIcon`, and `LocationIcon` to `constants.tsx` for use in the CV's contact section.
    - **Type Updates**: `src/types/index.ts` updated: `ContactInfo` now includes `website` and `location`. `ParsedSection` can now have `subSections` (for categorized skills). `ExperienceEntryCv` and `EducationEntryCv` refined for more detailed parsing.
    - `index.css`: Added 'Georgia' to the font stack for a classic resume feel.
- **Modern CV Rendering Design**:
    - Major visual overhaul of the `CVRenderer` component (`components/cv/CVRenderer.tsx`) to display generated CV outlines in a modern, professional, two-column format inspired by contemporary resume designs (similar to the "Lucy Ricci" example).
    - **Layout**: Features a left sidebar (typically for a profile image and concise contact details) and a main content area on the right.
    - **Props**: `CVRenderer` now accepts optional props: `userName`, `userEmail`, `userPhone`, `userLinkedIn`, and `profileImageUrl` to personalize the rendered CV header and sidebar. If these are not provided, the renderer attempts to parse them from the `cvText`.
    - **Visuals**:
        - Includes placeholders for a profile picture. If `profileImageUrl` is provided (e.g., from `currentUser`), it's used.
        - Incorporates subtle decorative background elements (approximated "cloud" shapes using CSS `clip-path` and yellow accent colors) for visual appeal.
        - Utilizes a professional color palette (whites, yellows, dark grays) and modern typography (using existing 'Roboto' and 'Georgia' fonts) with clear visual hierarchy.
    - **Parsing Enhancements**: The parsing logic in `CVRenderer` has been improved to better identify and structure sections like "Personal Profile" (mapping from AI's "Summary/Objective"), "Education", "Work Experience", and "Skills" for the new layout. It also tries to extract contact details more effectively if not provided via props.
    - **Integration**:
        - `HeroSection.tsx`: Now passes `currentUser` details (name, email, phone, LinkedIn, profilePhotoUrl) to `CVRenderer` for CVs generated by logged-in users, enabling immediate personalized and styled preview.
        - `UserDashboardPage.tsx`: The modal for viewing saved CVs now also passes `currentUser` details along with the `generated_cv_text` to `CVRenderer`, ensuring saved CVs are displayed in the new modern style. Modal styling for CV view improved (full-width/height on small screens, max-width/height on larger).
    - **Types**: Updated `CVRendererProps` and related parsing types in `src/types/index.ts`. Added `placeholder` to `ExperienceEntryCv` and `EducationEntryCv` to better handle AI outline prompts.
    - **Styling**: `index.css` updated to include 'Georgia' as a fallback font and define a `grid-cols-cvLayout` utility (though ideally this would be in `tailwind.config.js`).
- **CV Design Rendering**:
    - Implemented a new `CVRenderer` component (`components/cv/CVRenderer.tsx`) that parses raw AI-generated CV text and renders it in a visually structured, professional resume format using Tailwind CSS.
    - The renderer identifies and styles common CV sections: Name, Contact Information, Summary/Objective, Skills, Work Experience, and Education.
    - Parsing logic attempts to structure content within sections (e.g., bullet points for skills, entries for experience/education with titles, companies/institutions, dates, and descriptions).
    - **Hero Section Integration**: The `HeroSection.tsx` now uses `CVRenderer` to display the generated CV outline immediately after creation, replacing the previous raw text `<pre>` tag display.
    - **User Dashboard Integration**: The modal for viewing saved CVs in `UserDashboardPage.tsx` now utilizes `CVRenderer` to display the `generated_cv_text` in the new resume format, enhancing the user experience for reviewing saved CVs. Modal dimensions were adjusted for better CV display.
    - Added new TypeScript types (`ParsedSection`, `ContactInfo`, `ExperienceEntryCv`, `EducationEntryCv`) to `src/types/index.ts` to support the structured data for `CVRenderer`.
- **Saved CVs Functionality for Logged-In Users**:
    - Logged-in users can now have their generated CV outlines automatically saved to their account.
    - **Database**: Introduced a new `saved_cvs` table in MySQL to store generated CVs. The table includes `user_id` (foreign key to `users` table with ON DELETE CASCADE), `job_info_query` (the original text user entered), `generated_cv_text` (the full AI-generated CV outline), `cv_title` (automatically generated from the job query), `tags` (JSON array of strings derived from user's profile), and timestamps.
    - **Automatic Tagging**: When a CV is saved, it's automatically tagged with keywords extracted from the user's current profile information (work experience titles, education degrees/fields of study, languages spoken, and professional headline).
    - **Backend (`server/routes/cvRoutes.js`, `server/services/cvStoreService.js`)**:
        - The `/api/cv/generate` endpoint now automatically saves the CV for logged-in users after successful generation and credit deduction. It fetches user profile data to create relevant tags.
        - Created a new service `server/services/cvStoreService.js` to manage all database interactions for saved CVs, including creation, retrieval (list and details), and deletion. This service includes robust error handling, especially for parsing JSON tags from the database (gracefully handles malformed JSON by logging a warning and returning null for tags, rather than failing the entire request).
        - Added new protected API endpoints for managing saved CVs:
            - `GET /api/cv/saved`: Fetches a paginated list of saved CVs (title, creation date, tags) for the authenticated user.
            - `GET /api/cv/saved/:cvId`: Fetches the full details (including `generated_cv_text`) of a specific saved CV owned by the authenticated user.
            - `DELETE /api/cv/saved/:cvId`: Deletes a specific saved CV owned by the authenticated user.
        - Enhanced logging in CV routes and services for better diagnostics.
    - **Frontend (`pages/UserDashboardPage.tsx`, `services/geminiService.ts`, `components/HeroSection.tsx`)**:
        - Added a `SavedCv` interface to `src/types/index.ts`.
        - Updated `services/geminiService.ts`:
            - The `generateCVContent` function now sends the `userId` to the backend.
            - Added new functions (`getSavedCvs`, `getSavedCvById`, `deleteSavedCvById`) to interact with the new CV storage backend APIs, using the existing mock authentication header.
        - Enhanced `pages/UserDashboardPage.tsx` with a "My Saved CVs" section:
            - Displays a list of the user's saved CVs showing title, creation date, and a snippet of tags.
            - Implements functionality to fetch the list of saved CVs on component mount and via a "Refresh" button.
            - Allows users to "View" the full details of a saved CV (title, original query, all tags, and the full generated text) in a modal dialog.
            - Allows users to "Delete" saved CVs with a confirmation prompt.
            - Includes loading indicators and error message displays for CV operations.
        - Updated `components/HeroSection.tsx`:
            - After a logged-in user successfully generates a CV, a success message "CV outline generated and automatically saved to your dashboard!" is displayed to inform them of the auto-save.
- **UI Enhancements for Credit System**:
    - Updated credit messages in `HeroSection.tsx` for unregistered users to be more direct and include a call to action (button) to register/sign up for more credits.
    - Added a tooltip to the "Create My AI CV" button in `HeroSection.tsx` that displays "Cost: 5 credits per generation" on hover.
    - Passed `onOpenAuthModal` prop to `HeroSection` to enable triggering the auth modal.
- **Credit System for CV Generation**:
    - Each Gemini API call for CV generation costs 5 credits.
    - **Registered Users**:
        - Receive 50 free credits daily.
        - Database `users` table updated with `credits_available` and `credits_last_reset_date` columns.
        - Backend logic in `userService.js` to initialize, reset, check, and decrement credits.
        - `/api/cv/generate` route now checks and updates credits for registered users.
        - User's available credits are displayed on the Hero section and User Dashboard.
    - **Unregistered Users**:
        - Receive 5 free credits daily, tracked via browser `localStorage`.
        - Hero section displays remaining free CV generations and disables generation if credits are depleted.
    - Updated `User` type and `App.tsx` to manage credit-related fields in global state.
    - Added credit constants (`GEMINI_CALL_COST`, `DEFAULT_CREDITS_REGISTERED`, `DEFAULT_CREDITS_UNREGISTERED`) to `constants.tsx`.
    - `geminiService.ts` updated to pass `userId` to the backend for credit checking.
- **Major Codebase Modularization**:
    - **Frontend**:
        - Centralized all shared TypeScript interfaces (User, WorkExperience, etc.) into `src/types/index.ts`.
        - Updated all frontend components and services to import types from `src/types/index.ts`.
    - **Backend (`server/`)**:
        - Refactored the monolithic `server/main.js` into a modular structure:
            - `server/config/`: For database, mailer, analytics, and app configurations.
            - `server/routes/`: For API route definitions (auth, CV, analytics).
            - `server/services/`: For business logic (user service, email service, AI service, analytics service, internal auth orchestrator).
            - `server/utils/`: For utility functions (sanitizeUser, tokenUtils).
        - `server/main.js` now serves as the main orchestrator, setting up Express, middleware, and mounting the modular routes.
- Created `changelog.md` to track project updates.
- User Dashboard: Added "Change Password" functionality for users who signed up with email/password.
    - New UI section in `UserDashboardPage.tsx`.
    - New `changePassword` service in `authService.ts`.
    - New `/api/auth/change-password` endpoint in `server/routes/authRoutes.js`.

### Changed
- `README.md`: Renamed internal changelog section. Added "Project Structure" and "Codebase Management" guidelines.
- **Authentication Logic (Backend)**:
    - Enhanced `/api/auth/login` to guide Google-first users appropriately.
    - `sanitizeUserForResponse` utility now includes a `hasLocalPassword` flag and credit system fields.
- **User Interface (`App.tsx`, `pages/UserDashboardPage.tsx`)**:
    - `User` type (now in `src/types/index.ts`) includes `hasLocalPassword` and credit system fields.
    - Login success and session restoration handle `hasLocalPassword` and credit system fields.
    - `UserDashboardPage.tsx` uses `hasLocalPassword` for "Change Password" section visibility and provides better guidance for Google users.
- **Typography**: Applied Google-like typography (Roboto font, smooth rendering, consistent casing) globally via `index.css`. Scrollbar styles also moved to `index.css`.

### Fixed
- **Markdown Bold Text Rendering**:
    - Enhanced `CVRenderer.tsx` by adding a `renderFormattedText` helper function. This function parses text content and correctly converts Markdown-style bold text (e.g., `**text**`) into HTML `<strong>text</strong>` elements.
    - Applied this helper across various text-bearing elements within the `CVRenderer` (summaries, list items, descriptions) to ensure bold formatting from the AI outline is displayed visually, rather than as raw asterisks.
- **User Dashboard (`pages/UserDashboardPage.tsx`):**
    - Fixed TypeScript error in `handleArrayItemChange` by asserting `newItem` to `WorkExperience | EducationEntry` when accessing `endDate`.
    - Added a "Set/Reset Password via Email" button for Google-linked users who do not have a local password.
- Corrected `LoadingSpinner` rendering in `UserDashboardPage.tsx` from `<LoadingSpinner />` to `{LoadingSpinner}` as it's a ReactNode.